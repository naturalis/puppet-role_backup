#!/bin/bash
#
# PgSQL Backup Script
#Dumps postgres databases to a file for another backup tool to pick up.
#
##### START CONFIG ###################################################

USER=<%= @pgsqlbackupuser %>
DIR=<%= @backuprootfolder %>/pgsql
PREFIX=pgsql

##### STOP CONFIG ####################################################
PATH=/usr/bin:/usr/sbin:/bin:/sbin

set -o pipefail
chown -R ${USER}:root /var/backup

<% if @pgsqlalldatabases == true -%>
su - ${USER} -c "pg_dumpall" | gzip -c > ${DIR}/${PREFIX}.gz
<% else -%>
<% @pgsqldatabasearray.each do |db| -%>
su - ${USER} -c "pg_dumpall -g -U postgres -f ${DIR}/${PREFIX}_<%=db %>_globals.sql"
su - ${USER} -c "pg_dump <%=db %> -Fc --schema-only -f ${DIR}/${PREFIX}_<%=db %>_schemaonly.dump"
su - ${USER} -c "pg_dump <%=db %> -Fc -f ${DIR}/${PREFIX}_<%=db %>.dump"
<% end -%> 
<% end -%>

chown -R root:root /var/backup
